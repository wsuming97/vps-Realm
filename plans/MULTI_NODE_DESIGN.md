# 多节点集中管理功能设计

## 📋 需求描述

**场景**: 用户有 A、B、C、D 四台机器
- A 和 B 都安装了 Realm 面板
- 需要配置 A→C、B→D 的转发规则
- **痛点**: 目前需要分别登录 A 和 B 的 Web 面板进行管理

**期望**: 在一个面板中管理多台中转机的转发规则

---

## 🏗️ 架构方案

### 方案一: 主从架构 (推荐)

```
┌─────────────────────────────────────────────────────────────┐
│                    主控制面板 (Master)                        │
│                    部署在任意一台机器                          │
└─────────────────────┬───────────────────────────────────────┘
                      │ API 调用
        ┌─────────────┼─────────────┬─────────────┐
        │             │             │             │
        ▼             ▼             ▼             ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │ 机器 A   │   │ 机器 B   │   │ 机器 C   │   │ 机器 D   │
   │ (Agent)  │   │ (Agent)  │   │ (落地)   │   │ (落地)   │
   │ Realm    │   │ Realm    │   │          │   │          │
   └─────────┘   └─────────┘   └─────────┘   └─────────┘
```

**特点**:
- 一个主面板统一管理
- 每台中转机运行轻量 Agent
- Master 通过 API 控制各 Agent

---

### 方案二: 联邦架构

```
┌─────────────────────────────────────────────────────────────┐
│                    统一 Web 面板                             │
│                    可部署在任意位置                           │
└─────────────────────┬───────────────────────────────────────┘
                      │ 配置文件: nodes.toml
                      │
                      ▼
        ┌─────────────────────────────────────┐
        │           节点配置                   │
        │  - A: 192.168.1.1:8081             │
        │  - B: 192.168.1.2:8081             │
        └─────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
   ┌─────────────┐            ┌─────────────┐
   │  机器 A      │            │  机器 B      │
   │  原版面板    │            │  原版面板    │
   │  保持不变    │            │  保持不变    │
   └─────────────┘            └─────────────┘
```

**特点**:
- 原有面板保持不变
- 新增统一管理层
- 通过 API 代理请求

---

## 📐 推荐方案: 方案二 (联邦架构)

**理由**:
1. 对现有代码改动最小
2. 各节点可独立运行
3. 统一面板只是一个管理层

---

## 🔧 实现细节

### 1. 新增节点配置文件 `nodes.toml`

```toml
[[nodes]]
name = "中转机A"
host = "192.168.1.1"
port = 8081
password = "node_a_password"
https = false

[[nodes]]
name = "中转机B"
host = "192.168.1.2"
port = 8081
password = "node_b_password"
https = false
```

### 2. 新增数据结构

```go
// web/main.go 新增

type Node struct {
    Name     string `toml:"name"`
    Host     string `toml:"host"`
    Port     int    `toml:"port"`
    Password string `toml:"password"`
    HTTPS    bool   `toml:"https"`
}

type NodesConfig struct {
    Nodes []Node `toml:"nodes"`
}
```

### 3. 新增 API 接口

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/nodes` | 获取所有节点列表 |
| GET | `/api/nodes/:id/rules` | 获取指定节点的规则 |
| POST | `/api/nodes/:id/rules` | 向指定节点添加规则 |
| DELETE | `/api/nodes/:id/rules` | 删除指定节点的规则 |
| POST | `/api/nodes/:id/start` | 启动指定节点服务 |
| POST | `/api/nodes/:id/stop` | 停止指定节点服务 |
| GET | `/api/nodes/:id/status` | 获取指定节点状态 |

### 4. 代理转发逻辑

```go
// 代理请求到远程节点
func proxyToNode(node Node, method, path string, body []byte) (*http.Response, error) {
    scheme := "http"
    if node.HTTPS {
        scheme = "https"
    }
    
    url := fmt.Sprintf("%s://%s:%d%s", scheme, node.Host, node.Port, path)
    
    req, err := http.NewRequest(method, url, bytes.NewReader(body))
    if err != nil {
        return nil, err
    }
    
    // 需要先登录获取 session cookie
    // 或者使用 API Token 认证
    
    client := &http.Client{Timeout: 10 * time.Second}
    return client.Do(req)
}
```

### 5. 前端界面改动

```
┌─────────────────────────────────────────────────────────────┐
│  Realm 多节点管理面板                                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 中转机 A    │  │ 中转机 B    │  │ + 添加节点   │          │
│  │ ● 运行中    │  │ ○ 已停止    │  │             │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  当前选中: 中转机 A                                          │
│                                                             │
│  转发规则:                                                   │
│  ┌────────┬──────────────┬────────────┬──────┐              │
│  │ 序号   │ 中转端口      │ 落地机 IP   │ 端口  │              │
│  ├────────┼──────────────┼────────────┼──────┤              │
│  │ 1      │ 10001        │ 落地机C    │ 443  │              │
│  │ 2      │ 10002        │ 落地机C    │ 80   │              │
│  └────────┴──────────────┴────────────┴──────┘              │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 文件改动清单

| 文件 | 改动类型 | 说明 |
|------|----------|------|
| `web/nodes.toml` | 新增 | 节点配置文件 |
| `web/main.go` | 修改 | 新增节点管理 API |
| `web/static/app.js` | 修改 | 新增节点切换逻辑 |
| `web/templates/index.html` | 修改 | 新增节点选择 UI |

---

## 🔒 安全考虑

1. **节点认证**: 每个节点使用独立密码
2. **通信加密**: 建议节点间使用 HTTPS
3. **API Token**: 可选实现 API Token 认证替代 Session

---

## 📊 工作量评估

| 模块 | 复杂度 |
|------|--------|
| 后端 API | 中等 |
| 代理转发 | 中等 |
| 前端 UI | 中等 |
| 测试 | 简单 |

---

## ❓ 待确认问题

1. 是否需要批量操作功能（同时向多个节点添加相同规则）？
2. 节点离线时的处理策略？
3. 是否需要节点分组功能？
