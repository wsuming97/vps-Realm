# Realm é¡¹ç›®ä»£ç é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

ç»è¿‡å¯¹æ•´ä¸ªé¡¹ç›®ä»£ç çš„å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼š

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

### 1. å®‰å…¨é—®é¢˜

#### 1.1 Session å¯†é’¥ç¡¬ç¼–ç  (web/main.go:146)
```go
store := cookie.NewStore([]byte("secret"))
```
**é—®é¢˜**: Session å¯†é’¥ä½¿ç”¨ç¡¬ç¼–ç çš„ "secret"ï¼Œå­˜åœ¨å®‰å…¨é£é™©ã€‚
**å»ºè®®**: ä»é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¯»å–ï¼Œä½¿ç”¨å¼ºéšæœºå¯†é’¥ã€‚

#### 1.2 é»˜è®¤å¯†ç è¿‡äºç®€å• (web/config.toml:2)
```toml
password = "123456"
```
**é—®é¢˜**: é»˜è®¤å¯†ç ä¸ºå¼±å¯†ç  "123456"ã€‚
**å»ºè®®**: 
- é¦–æ¬¡è¿è¡Œæ—¶å¼ºåˆ¶ä¿®æ”¹å¯†ç 
- æˆ–ç”Ÿæˆéšæœºåˆå§‹å¯†ç 

#### 1.3 è¾“å…¥éªŒè¯ä¸è¶³ (web/main.go:230-247)
```go
authorized.POST("/add_rule", func(c *gin.Context) {
    var input ForwardingRule
    if err := c.ShouldBindJSON(&input); err != nil {
        c.JSON(400, gin.H{"error": "æ— æ•ˆçš„è¾“å…¥"})
        return
    }
    // ç¼ºå°‘å¯¹ listen å’Œ remote å­—æ®µçš„æ ¼å¼éªŒè¯
    mu.Lock()
    config.Endpoints = append(config.Endpoints, input)
    mu.Unlock()
```
**é—®é¢˜**: æ·»åŠ è§„åˆ™æ—¶æ²¡æœ‰éªŒè¯ listen/remote å­—æ®µçš„æ ¼å¼ã€‚
**å»ºè®®**: æ·»åŠ  IP:ç«¯å£ æ ¼å¼éªŒè¯å‡½æ•°ã€‚

---

### 2. ç«¯å£æ£€æµ‹é€»è¾‘é”™è¯¯ (realm.sh:78)

```bash
if ss -tulpn | grep -q ":${port} " | grep -v "realm"; then
```
**é—®é¢˜**: ç®¡é“ä¸­ `grep -q` åé¢çš„ `| grep -v "realm"` æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œå› ä¸º `grep -q` ä¸è¾“å‡ºä»»ä½•å†…å®¹ã€‚
**ä¿®å¤**:
```bash
if ss -tulpn | grep ":${port} " | grep -qv "realm"; then
```

---

### 3. å¹¶å‘å®‰å…¨é—®é¢˜ (web/main.go:238-240)

```go
mu.Lock()
config.Endpoints = append(config.Endpoints, input)
mu.Unlock()

if err := SaveConfig(); err != nil {  // SaveConfig å†…éƒ¨åˆæœ‰ mu.Lock()
```
**é—®é¢˜**: `SaveConfig()` å†…éƒ¨æœ‰è‡ªå·±çš„ `mu.Lock()`ï¼Œåœ¨å¤–éƒ¨å·²æŒæœ‰é”åå†è°ƒç”¨ä¼šå¯¼è‡´æ­»é”ï¼ˆè™½ç„¶ Go çš„ Mutex ä¸ä¼šå› ä¸ºåŒä¸€ goroutine é‡å…¥è€Œæ­»é”ï¼Œä½†è¿™æ˜¯ä»£ç é€»è¾‘é—®é¢˜ï¼‰ã€‚
**ä¿®å¤**: è°ƒæ•´é”çš„ç²’åº¦ï¼Œæˆ–ä½¿ç”¨ `sync.RWMutex`ã€‚

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 4. åºŸå¼ƒ API ä½¿ç”¨ (web/main.go:6, 54, 67, 104)

```go
import "io/ioutil"
// ...
data, err := ioutil.ReadFile("/root/.realm/config.toml")
```
**é—®é¢˜**: `ioutil` åŒ…åœ¨ Go 1.16+ å·²åºŸå¼ƒã€‚
**å»ºè®®**: ä½¿ç”¨ `os.ReadFile()` å’Œ `os.WriteFile()`ã€‚

---

### 5. ç¡¬ç¼–ç è·¯å¾„ (å¤šå¤„)

| ä½ç½® | ç¡¬ç¼–ç è·¯å¾„ |
|------|-----------|
| realm.sh:21-27 | `/root/realm`, `/root/.realm` |
| web/main.go:54 | `/root/.realm/config.toml` |
| web/main.go:104 | `/root/.realm/config.toml` |

**é—®é¢˜**: åªèƒ½ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œç¼ºä¹çµæ´»æ€§ã€‚
**å»ºè®®**: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶æŒ‡å®šè·¯å¾„ã€‚

---

### 6. å‰ç«¯åºå·è®¡ç®—é”™è¯¯ (web/static/app.js:96)

```javascript
row.innerHTML = `
    <td>${index + 1}</td>  // åˆ†é¡µååºå·ä» 1 å¼€å§‹ï¼Œä¸æ˜¯å…¨å±€åºå·
```
**é—®é¢˜**: åˆ†é¡µååºå·å§‹ç»ˆä» 1 å¼€å§‹ï¼Œåº”æ˜¾ç¤ºå…¨å±€åºå·ã€‚
**ä¿®å¤**:
```javascript
<td>${(currentPage - 1) * pageSize + index + 1}</td>
```

---

### 7. ç¼ºå°‘ CSRF é˜²æŠ¤ (web/main.go)

**é—®é¢˜**: POST è¯·æ±‚æ²¡æœ‰ CSRF token éªŒè¯ã€‚
**å»ºè®®**: æ·»åŠ  CSRF ä¸­é—´ä»¶ä¿æŠ¤æ•æ„Ÿæ“ä½œã€‚

---

### 8. HTTP é‡å®šå‘ç«¯å£ç¡¬ç¼–ç  (web/main.go:349-350)

```go
log.Printf("HTTP æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œç«¯å£ï¼š8082ï¼Œç”¨äºé‡å®šå‘åˆ° HTTPS\n")
if err := http.ListenAndServe(":8082", ...
```
**é—®é¢˜**: HTTP é‡å®šå‘æœåŠ¡å™¨ç«¯å£ç¡¬ç¼–ç ä¸º 8082ï¼Œæ— æ³•é…ç½®ã€‚
**å»ºè®®**: æ·»åŠ é…ç½®é¡¹æˆ–ä½¿ç”¨ 80 ç«¯å£ã€‚

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜/å»ºè®®

### 9. ä»£ç è´¨é‡æ”¹è¿›

#### 9.1 ç¼ºå°‘é”™è¯¯æ—¥å¿— (web/main.go)
æœåŠ¡æ§åˆ¶æ“ä½œå¤±è´¥æ—¶åªè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ²¡æœ‰è®°å½•è¯¦ç»†æ—¥å¿—ã€‚

#### 9.2 ç¼ºå°‘è¯·æ±‚é€Ÿç‡é™åˆ¶
ç™»å½•æ¥å£æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æš´åŠ›ç ´è§£ã€‚

#### 9.3 HTTPS é‡å®šå‘é€»è¾‘é‡å¤ (web/main.go:120-133, 348-359)
ä¸¤å¤„å®ç°äº†ç±»ä¼¼çš„ HTTPS é‡å®šå‘é€»è¾‘ï¼Œå¯ä»¥åˆå¹¶ã€‚

---

### 10. æ–‡æ¡£å’Œæ³¨é‡Š

- realm.sh ç¼ºå°‘å‡½æ•°æ–‡æ¡£æ³¨é‡Š
- web/main.go ç¼ºå°‘ API æ–‡æ¡£
- æ²¡æœ‰ API æ¥å£æ–‡æ¡£ (å»ºè®®æ·»åŠ  Swagger)

---

### 11. é…ç½®éªŒè¯

å¯åŠ¨æ—¶æ²¡æœ‰éªŒè¯é…ç½®æ–‡ä»¶çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§ã€‚

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| ä¼˜å…ˆçº§ | æ•°é‡ |
|--------|------|
| ğŸ”´ é«˜ | 3 |
| ğŸŸ¡ ä¸­ | 5 |
| ğŸŸ¢ ä½ | 3 |

---

## âœ… å»ºè®®ä¿®å¤é¡ºåº

1. **ç«‹å³ä¿®å¤**: ç«¯å£æ£€æµ‹é€»è¾‘é”™è¯¯ (#2)
2. **å°½å¿«ä¿®å¤**: Session å¯†é’¥ç¡¬ç¼–ç  (#1.1)ã€è¾“å…¥éªŒè¯ (#1.3)
3. **è®¡åˆ’ä¿®å¤**: åºŸå¼ƒ API (#4)ã€åºå·è®¡ç®— (#6)
4. **é•¿æœŸä¼˜åŒ–**: CSRF é˜²æŠ¤ã€é€Ÿç‡é™åˆ¶ã€è·¯å¾„é…ç½®åŒ–

---

## ğŸ”§ å¿«é€Ÿä¿®å¤ä»£ç ç‰‡æ®µ

### ä¿®å¤ realm.sh ç«¯å£æ£€æµ‹

```bash
# ç¬¬ 78 è¡Œä¿®æ”¹ä¸º:
if ss -tulpn 2>/dev/null | grep ":${port} " | grep -qv "realm"; then
```

### ä¿®å¤ web/main.go Session å¯†é’¥

```go
// åœ¨ PanelConfig ä¸­æ·»åŠ :
type PanelConfig struct {
    // ... ç°æœ‰å­—æ®µ
    Session struct {
        Secret string `toml:"secret"`
    } `toml:"session"`
}

// main å‡½æ•°ä¸­:
secret := panelConfig.Session.Secret
if secret == "" {
    secret = generateRandomSecret() // ç”Ÿæˆéšæœºå¯†é’¥
}
store := cookie.NewStore([]byte(secret))
```

### ä¿®å¤å‰ç«¯åºå·

```javascript
// web/static/app.js ç¬¬ 96 è¡Œ:
<td>${(currentPage - 1) * pageSize + index + 1}</td>
```
